# åˆçº§é˜¶æ®µ

## ä¸€ã€æ¦‚è¿°

### 1.1æ˜¯ä»€ä¹ˆ

> å¤§æ•°æ®ä¸­ä½¿ç”¨è¾ƒå¤šçš„å…¨æ–‡æœç´¢çš„**æœç´¢å¼•æ“ï¼**å¯¹æ¯” Solr (ä¹Ÿæ˜¯ä½¿ç”¨è¾ƒå¤šçš„æœç´¢å¼•æ“)

### 1.2ä¸ºä»€ä¹ˆä½¿ç”¨ElasticSearch

> ä¹‹å‰çš„å°å‹é¡¹ç›®ä¸­çš„æœç´¢åŠŸèƒ½ï¼Œæˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨MySQLçš„selectè¯­å¥å®Œæˆï¼Œåœ¨æ•°æ®é‡è¾ƒå°çš„æƒ…å†µä¸‹ï¼Œè¿™ç§æ–¹å¼(MySQL)é…åˆå…¨æ–‡ç´¢å¼•ç¡®å®å¯ç”¨ã€‚ä½†æ˜¯åœ¨é‡åˆ°å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹ï¼Œå°±ä¼šå¯¹MySQLé€ æˆå¾ˆå¤§çš„å‹åŠ›ã€‚

### 1.3ä½¿ç”¨çš„æ¡ˆä¾‹

> ç›®å‰æµè§ˆå™¨ä¸Šé¢ç½‘ç«™ä½¿ç”¨çš„æœç´¢åŠŸèƒ½åŸºæœ¬ä¸Šéƒ½æ˜¯ä½¿ç”¨è¿™ä¸€ç±»ä¸“ä¸šçš„æœç´¢å¼•æ“ï¼ŒåŠŸèƒ½å¼ºå¤§ã€‚(ä¾‹å¦‚ï¼šç™¾åº¦ã€äº¬ä¸œã€æ·˜å®ã€githubç­‰)ï¼Œä½¿ç”¨è¿‡éƒ½çŸ¥é“åœ¨ä½¿ç”¨è¿™äº›ç½‘ç«™æœç´¢çš„æ—¶å€™ï¼Œä½¿ç”¨ä½“éªŒå¥½çš„å¤šï¼Œæ‰€ä»¥ä¸“ä¸šçš„äº‹æƒ…è¿˜æ˜¯å¾—ä¸“ä¸šçš„äººæ¥åšã€‚å½“ç„¶å®ƒä¹Ÿå¯ä»¥ç”¨ä½œæ•°æ®åº“ï¼Œä½†æ˜¯å¹¶ä¸æ¨èã€‚

### 1.4è®¤è¯†ä¸€ä¸ªäºº(å¤§ä½¬)

æ¨èé˜…è¯»æ–‡ç« ï¼šã€ŠHadoopä¹‹çˆ¶â€”â€”Doug Cuttingã€‹https://www.cnblogs.com/doit8791/p/9556821.html

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590320967044-f9a4a883-32dd-4760-9526-e7c2df839e76.png)![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590321538032-f0de78e5-04e1-4fa4-b42c-5e2f4941d899.png)![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590321150817-3199acef-f5b5-4398-9181-957c2f4f2b8c.png)

è¿™ä¸ªäººå°±æ˜¯ç›®å‰å¦‚æ—¥ä¸­å¤©çš„å¤§æ•°æ®æ¡†æ¶Hadoopçš„åˆ›å§‹äººï¼š***Doug Cutting\***

ä¸ä»…å¦‚æ­¤**Lucene(Javaç¼–å†™çš„å…¨æ–‡æœç´¢æ¡†æ¶ï¼Œ****ç¬¬ä¸€ä¸ªæä¾›å…¨æ–‡æ–‡æœ¬æœç´¢çš„å¼€æºå‡½æ•°åº“****)**ä¹Ÿæ˜¯å‡ºè‡ªäºå®ƒä¹‹æ‰‹,ç›®å‰ç”±Apacheè½¯ä»¶åŸºé‡‘ä¼šå°±è¡Œç®¡ç†ã€‚Hadoopå°±æ˜¯Cuttingåœ¨Luceneä¸Šåˆ©ç”¨Googleçš„å…¬å¼€æŠ€æœ¯æ‰“é€ å‡ºæ¥çš„ã€‚

è€ŒSolrå’ŒElasticSearchå°±æ˜¯ä»¥Luceneä¸ºæ ¸å¿ƒè¿›è¡Œå°å¾—åˆ°çš„ã€‚

æˆ‘ä»¬çš„å­¦ä¹ ä¹Ÿæ˜¯è¿™ä¸‰è€…å¯¹æ¯”åˆ†æè¿›è¡Œå­¦ä¹ ã€‚



### 1.5å…³äºELK

Eï¼šElasticSearch(æœç´¢ã€å­˜å‚¨æ•°æ®)

Lï¼šLogstash(æ”¶é›†ï¼Œæ¸…æ´—æ•°æ®)

Kï¼šKibana(åˆ†æã€å±•ç¤ºæ•°æ®)

> è¿™ä¸€å¥—æ˜¯å¤§æ•°æ®ä¸­å¤„ç†æ—¥å¿—æ•°æ®åˆ†æå¿…å­¦çš„ã€‚

### 1.6å¯¹æ¯”Solr

| å¯¹æ¯”é¡¹       | Solr                             | ElasticSearch                              |
| ------------ | -------------------------------- | ------------------------------------------ |
| å®‰è£…         | è¾ƒä¸ºå¤æ‚                         | å¼€ç®±å³ç”¨                                   |
| åˆ†å¸ƒå¼ç®¡ç†   | ä½¿ç”¨Zookeeperè¿›è¡Œåˆ†å¸ƒå¼ç®¡ç†      | è‡ªå¸¦åˆ†å¸ƒå¼åè°ƒç®¡ç†åŠŸèƒ½                     |
| æ•°æ®æ ¼å¼æ”¯æŒ | jsonã€xmlã€csv                   | ä»…æ”¯æŒjson                                 |
| åŠŸèƒ½         | åŠŸèƒ½ä¸°å¯Œ                         | æ³¨é‡äºæ ¸å¿ƒ(æœç´¢)é«˜çº§åŠŸèƒ½é€šè¿‡ç¬¬ä¸‰æ–¹æ’ä»¶å®ç° |
| ä¼˜åŠ¿ã€åŠ£åŠ¿   | æŸ¥è¯¢å·²æœ‰æ•°æ®æ—¶é€Ÿåº¦å¿«æ›´æ–°ç´¢å¼•æ—¶æ…¢ | å»ºç«‹ç´¢å¼•å¿«ï¼ŒæŸ¥è¯¢è¾ƒæ…¢åŠæ—¶æ€§æŸ¥è¯¢å¿«           |
| åº”ç”¨åœºæ™¯     | ç”µå•†é¡¹ç›®                         | Facebookã€å¾®åšå®æ—¶æœç´¢ã€‚                   |



## äºŒã€å®‰è£…

### 2.1è½¯ä»¶åŒ…

- ElasticSearch+Kibanaï¼šhttps://www.elastic.co/cn/start
- ElasticSearch-headï¼šhttps://github.com/mobz/elasticsearch-head/releases

ä¹Ÿå¯ä»¥ä½¿ç”¨Googleæ’ä»¶ï¼šElasticSearch Head - webå‰ç«¯å±•ç¤ºæ’ä»¶

- ikåˆ†è¯å™¨ï¼šhttps://github.com/medcl/elasticsearch-analysis-ik/releases

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590326617328-c601b12c-5db2-4212-8a26-fb09dedaf369.png)

### 2.2æŸ¥çœ‹ç›®å½•

ElasticSearch:

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590327915395-2d7b528a-af85-457f-aa3f-21e8138f952b.png)

```
1. bin: å¯åŠ¨æ–‡ä»¶ç›®å½•
2. config: ç›¸å…³é…ç½®æ–‡ä»¶ç›®å½•
    - jvm.options è™šæ‹Ÿæœºç›¸å…³çš„é…ç½®
    > å…¶ä¸­æœ‰ä¸ªé‡è¦çš„é…ç½®ï¼š-Xmså’Œ-Xmx éƒ½æ˜¯1G,JVMä¸­è®²è¿‡è¿™æ˜¯é¡¹ç›®è¿è¡Œå ç”¨çš„æœ€å°/æœ€å¤§å†…å­˜ç©ºé—´ï¼Œè‹¥å†…å­˜ä¸æ˜¯å¾ˆå……è£•å¯ä»¥è°ƒæ•´åˆ°256M
  - log4j2ã€‚properties Log4jçš„é…ç½®æ–‡ä»¶
  - elasticsearch.yml ElasticSearchçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶
    > é‡Œé¢æœ‰å…³äºé›†ç¾¤ã€è·¯å¾„ã€å†…å­˜ã€ç½‘ç»œç­‰é…ç½®
    > é»˜è®¤ç«¯å£æ˜¯ 9200ï¼ï¼
3. jdk: è¿è¡Œçš„javaç¯å¢ƒ  
4. lib: ç›¸å…³çš„åº“
   > ä¸»è¦æ˜¯ElasticSearchçš„å¥—ä»¶ä»¥åŠLog4jã€Luceneã€jackson
5. logs: æ—¥å¿—è¾“å‡ºæ–‡ä»¶å¤¹
6. modules: ä¸€äº›åŠŸèƒ½æ¨¡å—
7. plugins: å­˜æ”¾æ’ä»¶çš„ç›®å½•
     > å½“æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ’ä»¶çš„æ—¶å€™åªéœ€è¦å°†æ’ä»¶çš„åŒ…æ”¾å…¥å³å¯(ä¾‹å¦‚å¾…ä¼šä¼šä½¿ç”¨çš„ikåˆ†è¯å™¨)
```



### 2.3å¯åŠ¨ElasticSearch

ç›´æ¥è¿è¡Œbinç›®å½•ä¸‹çš„elasticsearchå³å¯ï¼šæ˜¾ç¤ºé»˜è®¤ç«¯å£9200:

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590329068209-03b7778d-2330-4608-9d44-4b9bcac5d7c1.png)

ç›´æ¥è®¿é—®ï¼Œå¯ä»¥è·å–å¦‚ä¸‹çš„æ•°æ®ä¿¡æ¯ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590329153756-e41bfdd2-57c1-40cc-b302-f9742a556661.png)

### 2.4ä½¿ç”¨å¯è§†åŒ–å·¥å…·ï¼ˆelasticsearch-headï¼‰

å¦‚æœæ˜¯ä½¿ç”¨Chromeæ’ä»¶é‚£ä¹ˆè¿™é‡Œå¯ä»¥è·³è¿‡ã€‚é‡ç‚¹è®²ä½¿ç”¨node.jså¯åŠ¨é‡åˆ°çš„é—®é¢˜

åœ¨è§£å‹æ–‡ä»¶åï¼Œçœ‹åˆ°package.jsonå°±å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä½¿ç”¨webpackæ„å»ºçš„é¡¹ç›®

1. é¦–å…ˆè¦è¿›è¡Œèµ„æºä¾èµ–å¯¼å…¥

ç”±äºæˆ‘ä»¬ä¹‹å‰é…ç½®äº†å›½å†…åŠ é€Ÿæ‰€ä»¥ä½¿ç”¨ï¼š`cnpm install`

1. ç„¶åä½¿ç”¨`npm run start`å¯åŠ¨

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590330327037-227c959a-30e9-4040-8dd4-1613062b5c57.png)

1. è®¿é—®localhost:9100ï¼Œè¿›å…¥headç•Œé¢

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590330379398-c57512e5-e994-4554-934f-772f1258d49c.png)

è¿™ä¸ªç•Œé¢å’Œä½¿ç”¨æ’ä»¶çš„ä¸€æ¨¡ä¸€æ ·çš„ï¼Œä½†æ˜¯é—®é¢˜å°±åœ¨äºï¼Œä½¿ç”¨æ’ä»¶æ˜¯å¯ä»¥ç›´æ¥è¿æ¥åˆ°æˆ‘ä»¬å·²ç»å¯åŠ¨çš„ElasticSearchçš„ï¼Œä½†æ˜¯ä½¿ç”¨è¿™ç§æ–¹æ³•å°±ä¼šäº§ç”Ÿè·¨åŸŸçš„é—®é¢˜ã€‚

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590330641589-04b02747-af2f-415a-8768-12338285a507.png)

åœ¨elasticsearch.ymlä¸­é…ç½® ï¼š

```yml
http: 
  cors: 
    enabled: true
    allow-origin: "*"
# å¼€å¯æ”¯æŒè·¨åŸŸï¼Œå¹¶ä½¿å¾—æ‰€æœ‰äººå¯ä»¥è®¿é—®
```

ç„¶åä¿å­˜å†æ¬¡å¯åŠ¨

ç°åœ¨å°±å¯ä»¥æˆåŠŸè¿æ¥äº†ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590331060077-e201a174-6f4e-4287-9648-3269217e7b1a.png)

åˆå­¦æ—¶ï¼Œè¿™é‡Œé¢ç´¢å¼•å°±ç›¸å½“äºä¸€ä¸ªæ•°æ®åº“ã€‚å­˜æ”¾æ•°æ®çš„æ˜¯ä¸€ä¸ªæ–‡æ¡£ã€‚

è¿™ä¸ªç½‘ç«™æˆ‘ä»¬å­¦ä¹ è¿‡ç¨‹ä¸­ä½œä¸ºæ•°æ®æŸ¥çœ‹ï¼Œå…·ä½“æŸ¥è¯¢å­˜å‚¨æ“ä½œä½¿ç”¨Kibanaè¿›è¡Œã€‚



### 2.5Kabanaå®‰è£…

ä¸€å®šè¦å’ŒElasticSearchçš„ç‰ˆæœ¬ä¸€è‡´ï¼

è§£å‹è€—æ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„å‰ç«¯å·¥ç¨‹ã€‚
è§£å‹å®Œæˆåç›´æ¥å¯åŠ¨/bin/kibana.batå°±å¯ä»¥å¯åŠ¨

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590332051218-81a2c31a-61b0-49f9-ab20-fd3f7bba8acf.png)

é»˜è®¤ç«¯å£æ˜¯5601ï¼Œè®¿é—®æµ‹è¯•ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590332113861-20c7a46f-5947-4c74-beba-685cc6be12ca.png)

ä¸€ä¸ªå¼‚å¸¸ç‚«é…·èˆ’æœçš„ç•Œé¢ï¼æ‰¾åˆ°Dev Toolsè¿›å…¥å‘½ä»¤è¡Œç•Œé¢ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ—¥åç»å¸¸ä½¿ç”¨çš„å‘½ä»¤çš„ä½ç½®ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590332326508-0bcca572-f421-4945-975e-a01928e8693f.png)å¦‚æœè§‰å¾—è‹±æ–‡ç•Œé¢ä¸é€‚åº”ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œæ±‰åŒ–ï¼

åœ¨kabanaçš„x-packç›®å½•ä¸‹çš„æ’ä»¶ç›®å½•ä¸­æœ‰ä¸€ä¸ªtranslationsç›®å½•ã€‚å…¶ä¸­å°±æ”¾ç€å›½é™…åŒ–çš„ä¸¤ä¸ªé…ç½®æ–‡ä»¶å…¶ä¸­å°±æœ‰zh-CN.json

```
kibana-7.7.0-windows-x86_64\x-pack\plugins\translations\translations\zh-CN.json
```

ç„¶åæˆ‘ä»¬åœ¨kabanaçš„configç›®å½•ä¸­çš„kabana.ymlä¸­é…ç½®ï¼š

```
i18n.locale: "zh-CN"
```

é‡æ–°å¯åŠ¨å³å¯ã€‚

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590332790587-6ea3a120-a6a6-495c-a2c7-7f65520c0ef8.png)



## ä¸‰ã€ElasticSearchä½¿ç”¨

### 3.1æ ¸å¿ƒæ¦‚å¿µ



ä¸å…³ç³»å‹æ•°æ®åº“å¯¹æ¯”ï¼š

| **RelationDB**   | **ElasticSearch** |
| ---------------- | ----------------- |
| æ•°æ®åº“(DataBase) | ç´¢å¼•(indices)     |
| è¡¨(Table)        | types(å³å°†è¿‡æ—¶)   |
| è¡Œ(row)          | æ–‡æ¡£(documents)   |
| å­—æ®µ(columns)    | field             |

-  ElasticSearchæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯json
- å•ä¸ªElasticSearchä¹Ÿæ˜¯ä¸€ä¸ªé›†ç¾¤ï¼Œé›†ç¾¤çš„é»˜è®¤åå­—å°±æ˜¯ElasticSearch

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590334480856-7d3d4896-e3fe-454d-8b66-10dafdf4f1a0.png)

> æ–‡æ¡£

ElasticSearchæ˜¯é¢å‘æ–‡æ¡£çš„ï¼Œä¸€ä¸ªç´¢å¼•ä¸­å¯ä»¥æœ‰å¤šä¸ªæ–‡æ¡£ï¼Œæœç´¢çš„æœ€å°å•ä½å°±æ˜¯æ–‡æ¡£ï¼Œä»¥key:valueå½¢å¼è®¾ç½®ã€‚



> ç±»å‹

ä¹Ÿå°±æ˜¯æ–‡æ¡£ä¸­valueçš„æ•°æ®ç±»å‹ï¼Œä¸å…³ç³»å‹æ•°æ®åº“ä¸€æ ·ï¼Œç›¸å½“äºä¸€ä¸ªäºŒçº§ç›®å½•

æ•°æ®éƒ½éœ€è¦æœ‰æŒ‡å®šç±»å‹ï¼Œä½†æ˜¯ElasticSearchå¯ä»¥è‡ªè¡Œæ¨æ–­ä½†æ˜¯éš¾å…æœ‰é”™è¯¯çš„æ—¶å€™ã€‚



> ç´¢å¼•

ç´¢å¼•ç›¸å½“äºä¸€ä¸ªæ•°æ®åº“ï¼Œæ˜¯å¤šä¸ªæ–‡æ¡£çš„é›†åˆ

æ¯ä¸ªç´¢å¼•ä¸­éƒ½åŒ…å«äº”ä¸ªåˆ†ç‰‡ï¼Œè¿™äº”ä¸ªåˆ†ç‰‡åº•å±‚å°±æ˜¯5ä¸ªLuceneç´¢å¼•ï¼Œç´¢å¼•çš„åˆ†ç‰‡ç›¸å½“äºMySQLçš„åˆ†åº“ã€‚

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590335447945-c7ad8368-73f2-4756-887e-27b5af85d329.png)

Luceneç´¢å¼•ä¸­ç”¨åˆ°äº†**å€’æ’ç´¢å¼•**

> **å€’æ’ç´¢å¼•ï¼š**å®ç°â€œå•è¯-æ–‡æ¡£çŸ©é˜µâ€çš„ä¸€ç§å…·ä½“å­˜å‚¨å½¢å¼ï¼Œé€šè¿‡å€’æ’ç´¢å¼•ï¼Œå¯ä»¥æ ¹æ®å•è¯å¿«é€Ÿè·å–åŒ…å«è¿™ä¸ªå•è¯çš„æ–‡æ¡£åˆ—è¡¨ã€‚å€’æ’ç´¢å¼•ä¸»è¦ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼šâ€œå•è¯è¯å…¸â€å’Œâ€œå€’æ’æ–‡ä»¶â€ã€‚
>
> 
>
> å‚è€ƒé˜…è¯»:https://blog.csdn.net/starzhou/article/details/87519973



### 3.2 IKåˆ†è¯å™¨

ä»€ä¹ˆæ˜¯åˆ†è¯å™¨ï¼Ÿ

> å°†ä¸€ä¸ªä¸­æ–‡å•è¯æˆ–è€…å¥å­æ‹†åˆ†æˆå¤šä¸ªå…³é”®å­—ï¼Œç„¶åæœç´¢çš„æ—¶å€™ç›´æ¥å¯¹è¿™äº›å…³é”®å­—è¿›è¡ŒåŒ¹é…ç­›é€‰ã€‚
>
> ä½†æ˜¯æœ‰æ—¶å€™è¿‡åº¦çš„æ‹†åˆ†åè€Œä¼šå¸¦æ¥è´Ÿé¢æ•ˆæœï¼Œæ‰€ä»¥ä½¿ç”¨ikåˆ†è¯å™¨è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

å¦‚æœå¤§é‡ä½¿ç”¨çš„æ˜¯ä¸­æ–‡æœç´¢ï¼Œå»ºè®®ä½¿ç”¨ikåˆ†è¯å™¨



IKåˆ†è¯å™¨æä¾›äº†ä¸¤ä¸ªåˆ†è¯ç®—æ³•ï¼š

- **`ik_smart`** ï¼šæœ€å°‘åˆ‡åˆ†
- **`ik_max_word`** : æœ€ç»†ç²’åº¦æ‹†åˆ†



å°†ikåˆ†è¯å™¨çš„è§£å‹æ–‡ä»¶æ”¾å…¥ElasticSearchä¸­çš„pluginsç›®å½•ä¸‹ï¼Œç„¶åé‡å¯ElasticSearchã€‚

å¯ä»¥çœ‹åˆ°åŠ è½½äº†ikåˆ†è¯å™¨æ’ä»¶ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590336690720-e4aef931-1924-4471-a592-ae0f77656f8e.png)

æˆ–è€…ä½¿ç”¨`elasticsearch-plugin list`å‘½ä»¤ä¹Ÿå¯ä»¥æŸ¥çœ‹ä½¿ç”¨äº†çš„æ’ä»¶ã€‚

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590336661289-2adda762-d6b4-48a2-af39-ef32028aac00.png)



### 3.3æµ‹è¯•ä½¿ç”¨ä¸¤ç§åˆ†è¯ç®—æ³•

```json
**ik_smart**
GET _analyze
{
  "analyzer": "ik_smart",// ä½¿ç”¨æœ€å°‘åˆ’åˆ†ç®—æ³•
  "text": ["ä¸­å›½å…±äº§å…š"]
}
```

ç»“æœï¼š

```json
{
  "tokens" : [
    {
      "token" : "ä¸­å›½å…±äº§å…š",
      "start_offset" : 0,
      "end_offset" : 5,
      "type" : "CN_WORD",
      "position" : 0
    }
  ]
}
```



**`ik_max_word`**

```json
GET _analyze
{
  "analyzer": "ik_max_word",// ä½¿ç”¨æœ€å°ç²’åº¦ç®—æ³•
  "text": ["ä¸­å›½å…±äº§å…š"]
}
```

ç»“æœï¼š

```json
{
  "tokens" : [
    {
      "token" : "ä¸­å›½å…±äº§å…š",
      "start_offset" : 0,
      "end_offset" : 5,
      "type" : "CN_WORD",
      "position" : 0
    },
    {
      "token" : "ä¸­å›½",
      "start_offset" : 0,
      "end_offset" : 2,
      "type" : "CN_WORD",
      "position" : 1
    },
    {
      "token" : "å›½å…±",
      "start_offset" : 1,
      "end_offset" : 3,
      "type" : "CN_WORD",
      "position" : 2
    },
    {
      "token" : "å…±äº§å…š",
      "start_offset" : 2,
      "end_offset" : 5,
      "type" : "CN_WORD",
      "position" : 3
    },
    {
      "token" : "å…±äº§",
      "start_offset" : 2,
      "end_offset" : 4,
      "type" : "CN_WORD",
      "position" : 4
    },
    {
      "token" : "å…š",
      "start_offset" : 4,
      "end_offset" : 5,
      "type" : "CN_CHAR",
      "position" : 5
    }
  ]
}
```



åè€…å°†æ‰€æœ‰çš„å¯èƒ½çš„å•è¯æ‹†åˆ†å‡ºæ¥ã€‚

ä½†æ˜¯æœ‰å¯èƒ½å°†å•è¯è¿‡åº¦æ‹†åˆ†ï¼Œåè€Œè¾¾ä¸åˆ°æƒ³è¦çš„æ•ˆæœï¼š

```json
GET _analyze
{
  "analyzer": "ik_max_word",
  "text": ["æˆ‘æ˜¯å®˜å®‡è¾°"]
}
```

ç»“æœï¼š

```json
{
  "tokens" : [
    {
      "token" : "æˆ‘",
      "start_offset" : 0,
      "end_offset" : 1,
      "type" : "CN_CHAR",
      "position" : 0
    },
    {
      "token" : "æ˜¯",
      "start_offset" : 1,
      "end_offset" : 2,
      "type" : "CN_CHAR",
      "position" : 1
    },
    {
      "token" : "å®˜",
      "start_offset" : 2,
      "end_offset" : 3,
      "type" : "CN_CHAR",
      "position" : 2
    },
    {
      "token" : "å®‡",
      "start_offset" : 3,
      "end_offset" : 4,
      "type" : "CN_CHAR",
      "position" : 3
    },
    {
      "token" : "è¾°",
      "start_offset" : 4,
      "end_offset" : 5,
      "type" : "CN_CHAR",
      "position" : 4
    }
  ]
}
```

å®˜å®‡è¾°æ˜¯ä¸€ä¸ªåå­—ï¼Œä½†æ˜¯è¢«è¿‡åº¦æ‹†åˆ†æˆäº†ä¸‰ä¸ªç‹¬ç«‹çš„å…³é”®å­—ï¼Œé™ä½äº†æœç´¢çš„ç²¾ç¡®æ€§ã€‚è¿™ç§æƒ…å†µæˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªå•è¯é…ç½®åˆ°åˆ†è¯å™¨å­—å…¸ä¸­ï¼Œè®©ElasticSearchçŸ¥é“è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„å•è¯ã€‚



å†ElasticSearchçš„pluginsä¸­æ‰¾åˆ°ikåˆ†è¯å™¨çš„ç›®å½•å¹¶è¿›å…¥configï¼š

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590384539634-77d982ca-e208-4166-9884-d1e4832237c6.png)

æ‰€æœ‰`.dic`åç¼€çš„éƒ½æ˜¯ä¸€ä¸ªä¸ªå­—å…¸ï¼Œå¯ä»¥ç›´æ¥æ‰“å¼€æŸ¥çœ‹ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590384607475-c2f68269-44e5-4d69-a84f-99c8ea009459.png)ä»…ä»…è¿™äº›è‡ªå¸¦çš„å­—å…¸æ˜¯æ— æ³•æ»¡è¶³äºæˆ‘ä»¬çš„éœ€æ±‚çš„ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªè‡ªå·±çš„å­—å…¸ä¾‹å¦‚ï¼šsakura.dic æ‰“å¼€å­—å…¸ç„¶ååŠ å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„å•è¯`å®˜å®‡è¾°`

ç„¶åæ‰“å¼€IKAnalyzer.cfg.xmlæŠŠæˆ‘ä»¬è‡ªå·±çš„å­—å…¸æ·»åŠ è¿›å»ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590384969910-6bc1ffe1-4ad6-4430-8d86-4dafd61ec05b.png)

æœ€åé‡å¯ElasticSearchå’ŒKibanaï¼Œå¯åŠ¨æ—¥å¿—ä¸­ä¹Ÿä¼šæ˜¾ç¤ºåŠ è½½è‡ªå®šä¹‰çš„è¯å…¸ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590385132733-f2d1d702-e3b4-4d63-860e-0ea9a0629129.png)

å†æ¬¡æµ‹è¯•ï¼š

```json
{
  "tokens" : [
    {
      "token" : "æˆ‘",
      "start_offset" : 0,
      "end_offset" : 1,
      "type" : "CN_CHAR",
      "position" : 0
    },
    {
      "token" : "æ˜¯",
      "start_offset" : 1,
      "end_offset" : 2,
      "type" : "CN_CHAR",
      "position" : 1
    },
    {
      "token" : "å®˜å®‡è¾°",
      "start_offset" : 2,
      "end_offset" : 5,
      "type" : "CN_WORD",
      "position" : 2
    }
  ]
}
```

æ•ˆæœå¤§ä¸ç›¸åŒï¼Œè¿™æ¬¡`å®˜å®‡è¾°`ä»¥å®Œæ•´çš„å•è¯å‡ºç°ã€‚



### 3.4ç»“åˆRestFulé£æ ¼ä½¿ç”¨

| **method** | **url**                                     | **åŠŸèƒ½æè¿°**     |
| ---------- | ------------------------------------------- | ---------------- |
| PUT        | localhost:9200/ç´¢å¼•å/ç±»å‹å/æ–‡æ¡£id         | åˆ›å»ºæ–‡æ¡£å¹¶æŒ‡å®šid |
| POST       | localhost:9200/ç´¢å¼•å/ç±»å‹å                | åˆ›å»ºæ–‡æ¡£éšæœºid   |
| POST       | localhost:9200/ç´¢å¼•å/ç±»å‹å/æ–‡æ¡£id/_update | ä¿®æ”¹æŒ‡å®šidçš„æ–‡æ¡£ |
| DELETE     | localhost:9200/ç´¢å¼•å/ç±»å‹å/æ–‡æ¡£id         | åˆ é™¤æŒ‡å®šidçš„æ–‡æ¡£ |
| GET        | localhost:9200/ç´¢å¼•å/ç±»å‹å/æ–‡æ¡£id         | æŸ¥è¯¢æŒ‡å®šidçš„æ–‡æ¡£ |
| POST       | localhost:9200/ç´¢å¼•å/ç±»å‹å/_search        | æŸ¥è¯¢æ‰€æœ‰æ•°æ®     |

#### åˆ›å»ºç´¢å¼•å¹¶æ–°å»ºæ–‡æ¡£ï¼š

```json
PUT /test01/_doc/1
{
  "name": "sakura",
  "age": 20
}
```

æ³¨æ„ç‚¹ï¼š

1. åœ¨Kabanaä¸­æµ‹è¯•localhost:9200å‰ç¼€æ˜¯ä¸ç”¨å†™çš„ï¼
2. ç±»å‹å(type)åœ¨ä¸€ä¸ªç´¢å¼•ä¸­åªèƒ½æœ‰ä¸€ä¸ªtype
3. typeåœ¨ä»Šåçš„ç‰ˆæœ¬ä¸­å¯èƒ½è¢«å¯ç”¨ï¼Œurlä¸­çš„ç±»å‹åä½¿ç”¨`_doc`éšå¼ä»£æ›¿



ç»“æœï¼š

```json
{
  "_index" : "test01",
  "_type" : "_doc",
  "_id" : "1",
  "_version" : 1,
  "result" : "created",
  "_shards" : {
    "total" : 2,
    "successful" : 1,
    "failed" : 0
  },
  "_seq_no" : 0,
  "_primary_term" : 1
}
```

ä¿¡æ¯ï¼š

- (_index)æ“ä½œçš„ç´¢å¼•æ˜¯ï¼štest01
- (_type)ç±»å‹æ˜¯ï¼š_doc
- (_id)æ–‡æ¡£çš„idæ˜¯ï¼š1
- (result)æ“ä½œç±»å‹æ˜¯ï¼šcreated(åˆ›å»º)
- (_shards)åˆ†ç‰‡çš„ä¿¡æ¯



åœ¨ä¸Šé¢çš„æµ‹è¯•ä¸­æˆ‘ä»¬çš„å­—æ®µæ²¡æœ‰è®¾ç½®ç±»å‹ï¼Œæˆ‘ä»¬æ¥æŸ¥è¯¢ä¸€ä¸‹ï¼š



#### æŸ¥è¯¢æ–‡æ¡£

```
GET /test01/_doc/1
```

ç»“æœï¼š

```json
{
  "_index" : "test01",
  "_type" : "_doc",
  "_id" : "1",
  "_version" : 1,
  "_seq_no" : 0,
  "_primary_term" : 1,
  "found" : true,
  "_source" : {
    "name" : "sakura",
    "age" : 20
  }
}
```

åœ¨_sourceä¸­å¯ä»¥çœ‹åˆ°æ–‡æ¡£çš„å­—æ®µçš„å€¼

å¦‚æœè¦æŸ¥çœ‹ç´¢å¼•çš„ä¿¡æ¯(åŒ…æ‹¬å­—æ®µçš„ç±»å‹ä¿¡æ¯)ï¼š

```
GET /test01
```

ç»“æœï¼š

```json
{
  "test01" : {
    "aliases" : { },
    "mappings" : {
      "properties" : {
        "age" : {
          "type" : "long"
        },
        "name" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        }
      }
    },
    "settings" : {
      "index" : {
        "creation_date" : "1590389970005",
        "number_of_shards" : "1",
        "number_of_replicas" : "1",
        "uuid" : "jdkvBIGwSw6jOPLdvwDsOw",
        "version" : {
          "created" : "7070099"
        },
        "provided_name" : "test01"
      }
    }
  }
}
```

åœ¨mappingä¸­çš„propertiesä¸­å°±å¯ä»¥çœ‹åˆ°å­—æ®µçš„è¯¦ç»†ä¿¡æ¯ï¼ŒElasticSearchæ ¹æ®æ•°æ®ç±»å‹è‡ªåŠ¨æ¨æ–­æ•°æ®ç±»å‹ï¼Œå¹¶ä¸”textç±»å‹çš„æ•°æ®ä¼šé»˜è®¤åº•å±‚è®¾ç½®ä¸ºå…³é”®å­—(ä¹Ÿå³ä¸å¯æ‹†åˆ†å•è¯)ã€‚

å…¶æ¬¡settingä¸­ç»™å‡ºçš„æ˜¯å½“å‰ç´¢å¼•çš„ä¿¡æ¯ã€‚



#### å¸¦ç±»å‹åˆ›å»ºç´¢å¼•

å…ˆæ¥äº†è§£æœ‰å“ªäº›æ•°æ®ç±»å‹ï¼š

| **ä¸€çº§åˆ†ç±»** | **äºŒçº§åˆ†ç±»** | **å…·ä½“ç±»å‹**                         |
| ------------ | ------------ | ------------------------------------ |
| æ ¸å¿ƒç±»å‹     | å­—ç¬¦ä¸²ç±»å‹   | string,text,keyword                  |
| h            | æ•´æ•°ç±»å‹     | integer,long,short,byte              |
| h            | æµ®ç‚¹ç±»å‹     | double,float,half_float,scaled_float |
| h            | é€»è¾‘ç±»å‹     | boolean                              |
| h            | æ—¥æœŸç±»å‹     | date                                 |
| h            | èŒƒå›´ç±»å‹     | range                                |
| h            | äºŒè¿›åˆ¶ç±»å‹   | binary                               |
| å¤åˆç±»å‹     | æ•°ç»„ç±»å‹     | array                                |
| f            | å¯¹è±¡ç±»å‹     | object                               |
| f            | åµŒå¥—ç±»å‹     | nested                               |
| åœ°ç†ç±»å‹     | åœ°ç†åæ ‡ç±»å‹ | geo_point                            |
| d            | åœ°ç†åœ°å›¾     | geo_shape                            |
| ç‰¹æ®Šç±»å‹     | IPç±»å‹       | ip                                   |
| t            | èŒƒå›´ç±»å‹     | completion                           |
| t            | ä»¤ç‰Œè®¡æ•°ç±»å‹ | token_count                          |
| t            | é™„ä»¶ç±»å‹     | attachment                           |
| t            | æŠ½å–ç±»å‹     | percolator                           |

```json
PUT /test02
{
  "mappings": {
    "properties": {
      "name":{
        "type": "text"
      },
      "age":{
        "type": "integer"
      },
      "birth":{
        "type": "date"
      }
    }
  }
}
```

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590391708959-1c8909c6-96a3-4245-b9b4-a633d1182e99.png)æ­¤æ—¶ç´¢å¼•ä¸­è¿˜æ²¡æœ‰æ–‡æ¡£ï¼Œæˆ‘ä»¬çœ‹çœ‹ç´¢å¼•çš„ä¿¡æ¯

```json
{
  "test02" : {
    "aliases" : { },
    "mappings" : {
      "properties" : {
        "age" : {
          "type" : "integer"
        },
        "birth" : {
          "type" : "date"
        },
        "name" : {
          "type" : "text"
        }
      }
    },
    "settings" : {
      "index" : {
        "creation_date" : "1590391599265",
        "number_of_shards" : "1",
        "number_of_replicas" : "1",
        "uuid" : "oACx62V4TYaCO_RDeHI6Cg",
        "version" : {
          "created" : "7070099"
        },
        "provided_name" : "test02"
      }
    }
  }
}
```

æŒ‡å®šäº†ç±»å‹ä¹‹åç›¸å½“äºå»ºç«‹äº†ä¸€ä¸ªè§„åˆ™ï¼Œåé¢æ’å…¥è¿›æ¥çš„æ–‡æ¡£éƒ½è¦æŒ‰ç€è¿™ä¸ªè§„åˆ™è®¾ç½®æ•°æ®ï¼



#### æ’å…¥æ•°æ®

æ­£å¸¸æŒ‰å­—æ®µç±»å‹æ’å…¥ï¼š

```json
PUT /test02/_doc/1
{
  "name" : "å®˜å®‡è¾°",
  "age" : 20,
  "birth" : "2000-08-17"
}
```

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590392007690-860834fe-cc19-4499-a137-49d1ea6bdb65.png)æ•°æ®è§£ææ­£å¸¸ï¼

æ’å…¥æ•°æ®ç±»å‹äºå­—æ®µç±»å‹ä¸ç¬¦ï¼š

```json
PUT /test02/_doc/2
{
  "name" : 1234567,
  "age" : "sakura",
  "birth" : "2000-07-18"
}
```

è¿™æ ·ä¼šç›´æ¥æŠ¥é”™400-BadRequestï¼ä½†æ˜¯ å­—ç¬¦ä¸²å’Œæ•°å­—æ˜¯å¯ä»¥è‡ªåŠ¨è½¬åŒ–çš„ï¼š

```json
PUT /test02/_doc/2
{
  "name" : 1234567,
  "age" : "20",
  "birth" : "2000-07-18"
}
```

è¿™æ ·å°±ä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯æŸ¥è¯¢å‡ºæ¥çš„æ•°æ®è¿˜æ˜¯å­—ç¬¦ä¸²/æ•°å­—

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590392419822-ebc164a1-75f7-4edb-974c-eb147f37d247.png)



#### æ‰©å±•ï¼šæŸ¥çœ‹ElasticSearchçš„ç›¸å…³ä¿¡æ¯

```
GET _cat/xx

_cat/indices æŸ¥çœ‹æ‰€æœ‰ç´¢å¼•ä¿¡æ¯
_cat/plugins æŸ¥çœ‹ä½¿ç”¨çš„æ’ä»¶
_cat/nodes æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯
```



#### ä¿®æ”¹æ–‡æ¡£

æ–¹å¼ä¸€ï¼šç›´æ¥PUTè¿›è¡Œæ•°æ®è¦†ç›–

```json
PUT /test02/_doc/2
{
  "name" : "sakura",
  "age" : 19,
  "birth" : "2000-07-18"
}
```

æ¯æ¬¡ä¿®æ”¹ versionéƒ½ä¼šè‡ªå¢1ã€‚

ç¼ºç‚¹ï¼šä¸€æ—¦æ¼æ‰äº†å…¶ä¸­ä¸€ä¸ªå±æ€§ï¼Œé‚£ä¹ˆåŸæœ‰çš„å±æ€§ä¼šè¢«ç©ºå€¼è¦†ç›–ã€‚



æ–¹å¼äºŒï¼šä½¿ç”¨xx/_update

```json
POST /test02/_doc/2/_update
{
  "doc":{
    "name":"sakura",
    "birth" : "2000-08-17"
  }
}
```

æŒ‡å®šå­—æ®µè¿›è¡Œä¿®æ”¹ï¼Œä½†æ˜¯ç»“æœæ˜¾ç¤ºå»ºè®®æˆ‘ä»¬ä¿®æ”¹è¯·æ±‚çš„urlï¼š

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590394052252-e5abe878-1a51-415d-b829-987dcbcf28db.png)

\#!å¼ƒç”¨: [ç±»å‹åˆ é™¤] æ›´æ–°è¯·æ±‚ä¸­æŒ‡å®šæ–‡æ¡£çš„ç±»å‹å·²å¼ƒç”¨ï¼Œè¯·æ”¹ç”¨ç«¯ç‚¹/{index}/_ update/{id}ã€‚

æ‰€ä»¥æˆ‘ä»¬çš„æ­£ç¡®çš„urlåº”è¯¥æ˜¯ï¼š

```json
POST /test02/_update/2
{
  "doc":{
    "name":"sakura",
    "birth" : "2000-08-17"
  }
}
```



#### åˆ é™¤ç´¢å¼•/æ–‡æ¡£

åˆ é™¤æ–‡æ¡£

```json
DELETE /test02/_doc/2
```

åˆ é™¤ç´¢å¼•

```json
DELETE /test02
```



### 3.5å¤æ‚æŸ¥è¯¢



#### åŸºç¡€åŠŸèƒ½

åˆšå¼€å§‹æˆ‘ä»¬åªä½¿ç”¨äº†æœ€åŸºæœ¬çš„æŸ¥è¯¢æ–¹å¼ `GET xx/x` ç°åœ¨æ¥äº†è§£ä¸€ä¸‹ä½¿ç”¨å¤æ‚æŸ¥è¯¢

1. æŸ¥è¯¢ç´¢å¼•ä¸­æ‰€æœ‰æ–‡æ¡£æ•°æ®

```json
POST /test01/_search
```

éšç€æ–°ç‰ˆæ›´æ–°ï¼Œç±»å‹è¢«é€æ¸å¼ƒç”¨ã€‚

```json
{
  "took" : 0,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 3,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "test01",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : 1.0,
        "_source" : {
          "name" : "sakura",
          "age" : 20
        }
      },
      {
        "_index" : "test01",
        "_type" : "_doc",
        "_id" : "2",
        "_score" : 1.0,
        "_source" : {
          "name" : "è€ç‹",
          "age" : 35
        }
      },
      {
        "_index" : "test01",
        "_type" : "_doc",
        "_id" : "3",
        "_score" : 1.0,
        "_source" : {
          "name" : "å®˜å®‡è¾°ood",
          "age" : 20
        }
      }
    ]
  }
}
```

å®Œæ•´ç‰ˆï¼š

```json
GET /test01/_search
{
  "query": {
    "match_all": {}
  }
}
```



2. æŒ‰æ¡ä»¶æŸ¥è¯¢

```json
POST /test01/_search?q=name:sakura
{
  "took" : 0,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 1,
      "relation" : "eq"
    },
    "max_score" : 1.2800651,
    "hits" : [
      {
        "_index" : "test01",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : 1.2800651,
        "_source" : {
          "name" : "sakura",
          "age" : 20
        }
      }
    ]
  }
}
```



3. æŒ‰æ¡ä»¶æŸ¥è¯¢(äºŒ)

```json
GET /test01/_search
{
  "query": {
    "match": {
      "name": "sakura"
    }
  }
}
```

> è¿™ç§æŸ¥è¯¢æ–¹å¼ä¸­ matchä¸æ”¯æŒå¤šå­—æ®µæŸ¥è¯¢ï¼



4. æŸ¥è¯¢æ˜¾ç¤ºéƒ¨åˆ†å­—æ®µ

ä½¿ç”¨`_source`æŒ‡å®šè¦æŸ¥è¯¢æ˜¾ç¤ºçš„å­—æ®µ

```json
GET /test01/_search
{
  "query": {
    "match": {
      "name": "sakura"
    }
  },
  "_source": ["name"]
}
```

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590416799499-ca724d90-c201-411e-b798-9542af93df8e.png)



5. æŸ¥è¯¢ç»“æœæ’åº

ä½¿ç”¨`sort`æ¥æŒ‡å®šç”¨äºæ’åºçš„å­—æ®µ

```json
GET /test01/_search
{
  "query": {
    "match": {
      "name": "sakura"
    }
  }, 
  "sort": [
    {
      "age": {
        "order": "asc"
      }
    },
    {
      "_score": {
        "order": "desc"
      }
    }
  ]
}
```

- å¯ä»¥è®¾ç½®å¤šä¸ªæ’åºçš„å­—æ®µ
- ä½¿ç”¨æ’åºåmax_scoreä¼šå˜ä¸ºnullã€‚



6. åˆ†é¡µæŸ¥è¯¢

```json
GET /test01/_search
{
  "query": {
      "match": {
        "name": "sakura"
      }
  },
  "from": 0,
  "size": 2
}
```

fromã€sizeä¸¤ä¸ªå‚æ•°çš„å€¼å¯¹åº”SQLä¸­limitçš„ä¸¤ä¸ªå€¼ã€‚



#### å…³äºscoreå’Œhits

åœ¨æˆ‘ä»¬çš„æŸ¥è¯¢ç»“æœä¸­ï¼Œæ‰€æœ‰çš„æŸ¥è¯¢è®°å½•ä½¿ç”¨ä¸€ä¸ªhitså¯¹è±¡å‘ˆç°ï¼š

```json
"hits" : {
    "total" : {
      "value" : 2,
      "relation" : "eq"
    },
    "max_score" : 0.6133945,
    "hits" : [
      {
        "_index" : "test01",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : 0.6133945,
        "_source" : {
          "name" : "sakura"
        }
      },
      {
        "_index" : "test01",
        "_type" : "_doc",
        "_id" : "3",
        "_score" : 0.36372143,
        "_source" : {
          "name" : "å®˜å®‡è¾°sakura"
        }
      }
    ]
  }
```

`total`ï¼šå¯¹æŸ¥è¯¢ç»“æœçš„ä¸€ä¸ªç»Ÿè®¡ã€‚

`max_score`ï¼šè¡¨ç¤ºç»“æœæŸ¥è¯¢ç»“æœä¸­æœ€é«˜åŒ¹é…åº¦ã€‚

`hits`ï¼šä¸€ä¸ªæŸ¥è¯¢ç»“æœçš„æ•°ç»„ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ªä¸ªæŸ¥è¯¢ç»“æœå¯¹è±¡ã€‚

æ¯ä¸€ä¸ªhitä¸­éƒ½æœ‰ä¸€ä¸ª`_score`è¿™ä¸ªæ•°å€¼ä»£è¡¨ç€è¿™æ¡è®°å½•ä¸æŸ¥è¯¢æ¡ä»¶çš„åŒ¹é…ç¨‹åº¦ï¼Œåˆ†å€¼è¶Šé«˜åŒ¹é…åº¦è¶Šé«˜ã€‚



#### å¤šæ¡ä»¶æŸ¥è¯¢(must)

```json
GET /test01/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "name": "sakura"
          }
        },
        {
          "match": {
            "age": "20"
          }
        }
      ]
    }
  }
}
```

é¦–å…ˆæˆ‘ä»¬è¦ç”¨åˆ° queryé‡Œé¢çš„boolæŸ¥è¯¢ï¼Œç„¶åä½¿ç”¨must

mustæ˜¯ä¸€ä¸ªæ¡ä»¶æ•°ç»„ï¼Œå¯ä»¥åŒæ—¶æ”¾å¤šä¸ªæ¡ä»¶ï¼ŒæŸ¥è¯¢ç»“æœå¿…é¡»åŒæ—¶æ»¡è¶³è¿™äº›æ¡ä»¶ï¼

#### å¤šæ¡ä»¶æŸ¥è¯¢(should)

ä¸muståŠŸèƒ½ç±»ä¼¼ï¼Œä½†æ˜¯æ¡ä»¶æ•°ç»„ä¸­åªè¦æ»¡è¶³ä¸€ä¸ªå°±ä¼šåŠ å…¥ç»“æœé›†ä¸­ã€‚

#### å¤šæ¡ä»¶æŸ¥è¯¢(not must)

ä¸muståŠŸèƒ½åˆšå¥½ç›¸åï¼Œæ¡ä»¶æ•°ç»„ä¸­çš„æ¡ä»¶å¿…é¡»åŒæ—¶ä¸æ»¡è¶³ã€‚

#### å¤šå€¼æŸ¥è¯¢

åœ¨æŸ¥è¯¢æ—¶å€™æˆ‘ä»¬ä¼šç¢°åˆ°è¿™ç§æƒ…å†µï¼š

è¦æ±‚ç»“æœçš„å€¼æ˜¯åœ¨ç»™å®šçš„å¯é€‰å€¼ä¹‹ä¸­çš„ï¼šä¾‹å¦‚MySQLä¸­çš„in

```json
GET /test01/_search
{
  "query": {
      "match": {
        "name": "sakura å®˜å®‡è¾°"
      }
  }
}
```

æ¯”å¦‚ä¾‹å­ä¸­å°±æ˜¯æœ name in {"sarkua","å®˜å®‡è¾°"}



#### è¿‡æ»¤æŸ¥è¯¢(range)

```json
GET /test01/_search
{
  "query": {
    "bool": {
      "should": [
        {
          "match": {
            "name": "sakura"
          }
        }
      ],
      "filter": [
        {
          "range": {
            "age": {
              "gte": 10,
              "lte": 20
            }
          }
        }
      ]
    }
  }
}
```

ä¹Ÿæ˜¯boolæŸ¥è¯¢ä¸­çš„ï¼Œfilterä¸­ä¸»è¦æ˜¯å¯¹æŸ¥è¯¢çš„ç»“æœè¿›è¡Œä¸€å†™è¿‡æ»¤æ“ä½œï¼š

å¸¸ç”¨æœ‰

- `range`åˆ¤æ–­ä¸€ä¸ªæ•°å€¼çš„åœ¨æŸä¸ªåŒºé—´å†…ã€‚

- - gtï¼šå¤§äº
  - gteï¼šå¤§äºç­‰äº
  - ltï¼šå°äº
  - lteï¼šå°äºç­‰äº

- `exist`ç¡®è®¤æŸ¥è¯¢ç»“æœä¸­æŸä¸ªå­—æ®µæœ‰å€¼è€Œä¸æ˜¯ç©º



#### ç²¾ç¡®æŸ¥æ‰¾(term)

ä¸matchçš„åŒºåˆ«ï¼š

- termæ˜¯ç²¾ç¡®æŸ¥è¯¢ï¼šåŸºäºå€’æ’ç´¢å¼•ï¼Œä¸ä¼šå¯¹è¾“å…¥è¯è¿›è¡Œåˆ†è¯è§£æ

> å¿…é¡»åœ¨å†…å®¹ä¸­èƒ½å¤Ÿæ‰¾åˆ°å®Œæ•´çš„è¯æ‰èƒ½ä½œä¸ºç»“æœ

- matchåˆ™æ˜¯æ¨¡ç³ŠæŸ¥è¯¢ï¼Œä¼šé¦–å…ˆå¯¹è¾“å…¥è¯è¿›è¡Œåˆ†è¯ï¼Œç„¶åå°†åŒ¹é…çš„æ–‡æ¡£ä½œä¸ºç»“æœ

**å®ä¾‹ï¼š**

è¿™ä¸ªæ˜¯æˆ‘ä»¬å½“å‰çš„æ•°æ®ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590480508009-c48a57fc-8e89-4267-a66c-98ae7f07a998.png)

æµ‹è¯•å¯¹æ¯”ä¸€ä¸‹ä½¿ç”¨matchã€termåˆ†åˆ«æœç´¢sakuraï¼š

```json
GET /test01/_search
{
  "query": {
      "match": {
        "name": "sakura"
      }
  }
}

GET /test01/_search
{
  "query": {
      "term": {
        "name": {
          "value": "sakura"
        }
      }
  }
}
```

æœ€ç»ˆä¸¤è€…å¾—å‡ºçš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œè¿™æ˜¯å› ä¸ºè‹±æ–‡å•è¯æˆ–è€…è‹±æ–‡å’Œæ•°å­—ç»„åˆçš„å­—ç¬¦ä¸²åœ¨å­˜å‚¨çš„æ—¶å€™éƒ½ä¸ä¼šè¢«åˆ†è¯ï¼ä¹Ÿå°±æ˜¯è¯´æ•°æ®ä¸­çš„`sakuraã€å®˜å®‡è¾°sakura`åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­éƒ½ä¿ç•™äº†sakuraè¿™ä¸ªå®Œæ•´çš„è¯ï¼



é‚£ä¹ˆæˆ‘ä»¬å†æ¥æµ‹è¯•ä¸€ä¸‹æœ"å®˜å®‡è¾°"å‘¢ï¼Ÿ

ç»“æœæ˜¯ï¼š

- matchæ­£å¸¸ï¼Œæœåˆ°äº†ä¸¤æ¡ï¼Œå¹¶ä¸”åæ¥æˆ‘æµ‹è¯•å°±ç®—æ˜¯nameæ˜¯"å®˜å®‡"ã€"å®‡è¾°"ç­‰åªè¦ä¹‹ä¸­æœ‰è¿™ä¸ªä¸‰ä¸ªå­—çš„æ–‡æ¡£éƒ½ä¼šè¢«æ£€ç´¢åˆ°ï¼
- è€Œtermåˆ™æ˜¯ä¸€æ¡éƒ½æ²¡æœ‰æŸ¥åˆ°

ç°è±¡è§£é‡Šï¼š

> è¿™ä¸ªç°è±¡å¾ˆå¥½åœ°è§£é‡Šäº†ä¹‹å‰çš„å¯¹æ¯”
>
> - matchæœç´¢æ—¶å€™ï¼Œå°†æœç´¢è¯"å®˜å®‡è¾°"ï¼Œæ‹†åˆ†æˆäº†ä¸‰ä¸ªå•ç‹¬çš„å­—ï¼ç„¶åå»åŒ¹é…æ–‡æ¡£ï¼Œè€Œåˆç”±äºæ–‡æ¡£çš„nameå­—æ®µæ˜¯textç±»å‹åœ¨å­˜å‚¨çš„æ—¶å€™ä½¿ç”¨é»˜è®¤åˆ†è¯ï¼Œä¸­æ–‡è¯è¢«æ‹†åˆ†æˆå¤šä¸ªå­—ï¼Œæ‰€ä»¥éƒ½èƒ½åŒ¹é…ã€‚
> - åè§‚termï¼Œåœ¨æœç´¢çš„æ—¶å€™æœç´¢è¯"å®˜å®‡è¾°"æ˜¯æ²¡æœ‰è¢«å¤„ç†çš„ï¼Œéœ€è¦æ–‡æ¡£ä¸­æœ‰å®Œæ•´çš„"å®˜å®‡è¾°"è¿™ä¸ªè¯æ‰è¡Œï¼Œè€Œæ–‡æ¡£ä¸­éƒ½æ˜¯ä¸€ä¸ªä¸ªæ±‰å­—ï¼Œæ‰€ä»¥æ— ä¸€åŒ¹é…ã€‚

!!!!matchåœ¨å¯¹æœç´¢è¯è¿›è¡Œåˆ†è¯çš„æ—¶å€™ï¼Œæ˜¯å‚ç…§å­—æ®µç±»å‹è¿›è¡Œåˆ†è¯çš„!!!å½“å­—æ®µæ˜¯keywordå±æ€§æ—¶ï¼Œä½¿ç”¨matchä¹Ÿä¸ä¼šå¯¹æœç´¢è¯åˆ†è¯ã€‚



ä½¿ç”¨termsä¹Ÿå¯ä»¥å®ç°ç›¸åŒä¸matchçš„æ•ˆæœï¼š

```json
GET /test01/_search
{
  "query": {
      "terms": {
        "name": [
          "å®˜",
          "å®‡",
          "è¾°"
        ]
      }
  }
}
```

ä½¿ç”¨termsï¼Œåªéœ€è¦ä¿è¯æ‰€ç»™çš„å­—æ®µèƒ½åŒ¹é…æ‰€ç»™çš„è¯åˆ—è¡¨ä¸­ä»»æ„ä¸€ä¸ªå°±å¯ä»¥ã€‚



#### keywordå’Œtext

ä¸¤ä¸ªç±»å‹çš„åŒºåˆ«å…³é”®åœ¨äºæ•°æ®å­˜å‚¨/æœç´¢çš„æ—¶å€™æ˜¯å¦ä¼šè¢«è¿›è¡Œåˆ†è¯å¤„ç†ã€‚

```json
POST _analyze
{
  "analyzer": "keyword", 
  "text": ["sakuraå®˜å®‡è¾°gyc"]
}

POST _analyze
{
  "analyzer": "default", 
  "text": ["sakuraå®˜å®‡è¾°gyc"]
}
```

ç»“æœï¼š

keywordï¼š

```json
{
  "tokens" : [
    {
      "token" : "sakuraå®˜å®‡è¾°gyc",
      "start_offset" : 0,
      "end_offset" : 12,
      "type" : "word",
      "position" : 0
    }
  ]
}
```

textï¼š

```json
{
  "tokens" : [
    {
      "token" : "sakura",
      "start_offset" : 0,
      "end_offset" : 6,
      "type" : "<ALPHANUM>",
      "position" : 0
    },
    {
      "token" : "å®˜",
      "start_offset" : 6,
      "end_offset" : 7,
      "type" : "<IDEOGRAPHIC>",
      "position" : 1
    },
    {
      "token" : "å®‡",
      "start_offset" : 7,
      "end_offset" : 8,
      "type" : "<IDEOGRAPHIC>",
      "position" : 2
    },
    {
      "token" : "è¾°",
      "start_offset" : 8,
      "end_offset" : 9,
      "type" : "<IDEOGRAPHIC>",
      "position" : 3
    },
    {
      "token" : "gyc",
      "start_offset" : 9,
      "end_offset" : 12,
      "type" : "<ALPHANUM>",
      "position" : 4
    }
  ]
}
```



#### é«˜äº®æŸ¥è¯¢

åœ¨è®¸å¤šæœç´¢ç•Œé¢ï¼Œæœç´¢åˆ°çš„è¯éƒ½ä¼šä»¥é«˜äº®çš„å½¢å¼æ˜¾ç¤ºå‡ºæ¥ï¼ŒElasticSearchæ”¯æŒæœç´¢ç»“æœé«˜äº®

```json
GET /test01/_search
{
  "query": {
    "match": {
      "name": "å®˜å®‡è¾°"
    }
  },
  "highlight": {
    "fields": {
      "name": {}
    }
  }
}
```

åœ¨highlightçš„fieldä¸­è®¾ç½®è¦æ˜¾ç¤ºé«˜äº®çš„å­—æ®µï¼Œåœ¨æœç´¢ç»“æœä¸­è¯¥å­—æ®µä¸­åŒ¹é…çš„è¯å°±ä¼šå‡ºç°é«˜äº®ã€‚

éƒ¨åˆ†ç»“æœï¼š

```json
    "hits" : [
      {
        "_index" : "test01",
        "_type" : "_doc",
        "_id" : "3",
        "_score" : 1.8696017,
        "_source" : {
          "name" : "å®˜å®‡è¾°sakura",
          "age" : 20
        },
        "highlight" : {
          "name" : [
            "<em>å®˜</em><em>å®‡</em><em>è¾°</em>sakura"
          ]
        }
      },
      {
        "_index" : "test01",
        "_type" : "_doc",
        "_id" : "5",
        "_score" : 1.4723402,
        "_source" : {
          "name" : "å®˜å®‡",
          "age" : 22
        },
        "highlight" : {
          "name" : [
            "<em>å®˜</em><em>å®‡</em>"
          ]
        }
      }
    ]
```

é»˜è®¤æ˜¯ä½¿ç”¨<em>æ ‡ç­¾è¿›è¡ŒåŒ…è£¹ã€‚

æ¥çœ‹çœ‹ç™¾åº¦ä¸­ä½¿ç”¨çš„æ•ˆæœï¼š

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1461246/1590483717025-1a3bc61a-2230-4e69-b947-e0e68d8fc7d5.png)

å½“ç„¶è¿™ä¸ªæ ‡ç­¾æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼š

```json
"highlight": {
    "pre_tags": "<span class='key' style='color: red'}>",
    "post_tags": "</span>", 
    "fields": {
      "name": {}
    }
}
```

è®¾ç½®ä¸€ä¸‹pre_tagså’Œpost_tagså°±å¯ä»¥å®šåˆ¶é«˜äº®æ ‡ç­¾äº†ï¼

## å››ã€SpringBooté›†æˆES

### é¡¹ç›®æ­å»ºå‡†å¤‡

é¦–å…ˆæ‰¾å»å®˜ç½‘æ‰¾åˆ°å¸®åŠ©æ–‡æ¡£ï¼š

<img src="https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526203015.png" alt="image-20200526203015162" style="zoom:60%;" /><img src="https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526203053.png" alt="image-20200526203052955" style="zoom:50%;" />

é€‰æ‹©JavaRESTClientï¼Œç„¶åé€‰æ‹©High Level Rest Clientï¼›æ³¨æ„ä¸€å®šé€‰æ‹©å’Œè‡ªå·±ä½¿ç”¨ç›¸åŒç‰ˆæœ¬çš„æ–‡æ¡£ã€‚



ç„¶åä½¿ç”¨SpringBootæ„å»ºé¡¹ç›®çš„æ—¶å€™ï¼Œâ˜‘ï¸NoSQL -> Spring Data ElasticSearchï¼

![image-20200526202601147](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526202601.png)

ElasticSearchç›¸å…³çš„ä¾èµ–ï¼š

<img src="https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526221218.png" alt="image-20200526221218193" style="zoom:67%;" />

**SpringBoot2.6.0ç‰ˆæœ¬ä¸­ä½¿ç”¨çš„ElasticSearch-rest-high-level-clientç‰ˆæœ¬æ˜¯6.8.7**ã€‚ã€‚æˆ‘ä»¬å¿…é¡»å°†å…¶åˆ‡æ¢åˆ°å’Œæˆ‘ä»¬ä½¿ç”¨çš„ESä¿è¯åŒä¸€ä¸ªç‰ˆæœ¬æ‰èƒ½ç¨³å®šè¿æ¥ã€‚

åœ¨SpringBootçš„pom.xmlæ–‡ä»¶ä¸­ä½¿ç”¨ä¸€ä¸ªå˜é‡æ¥ç¡®å®šESçš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬åœ¨è‡ªå·±çš„é¡¹ç›®ä¸­é…ç½®è¿™ä¸ªå˜é‡å³å¯ï¼š

![image-20200526221851296](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526221851.png)

ä¿®æ”¹é¡¹ç›®çš„pom.xml

![image-20200526222150775](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526222150.png)

ç„¶ååˆ·ä¾èµ–ï¼Œç­‰å¾…ä¸‹è½½å®Œæ¯•ï¼š

![image-20200526222250403](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526222250.png)



### åˆå§‹åŒ–å‡†å¤‡

1. å®˜æ–¹æ–‡æ¡£ä¸­è¯´æ˜éœ€è¦ä¸€ä¸ª`RestHighLevelClient`å®ä¾‹ï¼Œæ¥å®Œæˆè¯·æ±‚ï¼š

   ![image-20200526224005250](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526224005.png)

   æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªElasticSearchçš„é…ç½®ç±»ï¼Œç„¶åä»¥Beançš„å½¢å¼åˆ›å»ºè¿™æ ·ä¸€ä¸ªå®ä¾‹ã€‚

2. ç¼–å†™é…ç½®ç±»å’ŒBean

   ```java
   @Configuration
   public class ElasticSearchClientConfig {
   
       @Bean
       public RestHighLevelClient restHighLevelClient() {
           RestHighLevelClient restHighLevelClient =
                   new RestHighLevelClient(
                           RestClient.builder(
                                   new HttpHost("localhost", 9200, "http")
                           ));
           return restHighLevelClient;
       }
   }
   ```

   ![image-20200526224800476](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526224800.png)

   åœ¨é…ç½®Beanå®Œæˆä¹‹åï¼Œæˆ‘ä»¬æ¥ç®€å•çœ‹çœ‹ElasticSearchçš„æºç å…¶å®åŸæœ¬æ˜¯æœ‰ä¸€ä¸ªRestHighLevelClientçš„é»˜è®¤å®ä¾‹ï¼Œç‚¹è¿‡å»ElasticSearchçš„æºç å¤§é™†ã€‚

   

3. æºç æµè§ˆ

   - æ¥åˆ°spring.factoriesæ–‡ä»¶ä¸­æ‰¾åˆ°ElasticSearchç›¸å…³çš„åŒ…ä»¥åŠç±»ï¼š

     ![image-20200526225854279](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526225854.png)

     ä¸€å…±11é¡¹è¿˜æ˜¯å¾ˆå¥½æ‰¾åˆ°çš„ï¼Œä¹Ÿå°±ä¸¤ä¸ªåŒ… dataå’Œelasticsearchï¼ŒLetâ€™s Goã€‚

   - é”å®šåŒ…çš„ä½ç½®ä»¥åŠå¤§è‡´å†…å®¹ï¼š

     dataåŒ…ï¼š(è¿™ä¸ªåŒ…é‡Œé¢æ”¾äº†å‡ ä¹æ‰€æœ‰æ•°æ®åº“ç›¸å…³çš„è‡ªåŠ¨é…ç½®ç›¸å…³çš„ç±»ï¼Œjdbcã€solrã€redisç­‰)

     <img src="https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526230220.png" alt="image-20200526230220362" style="zoom:67%;" />

     elasticsearchåŒ…ï¼š(ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„çš„RestClientï¼Œæ‰€ä»¥é‡ç‚¹åœ¨reståŒ…ä¸­)

     <img src="https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526230409.png" alt="image-20200526230409893" style="zoom:67%;" />

   - æˆ‘ä»¬ä»æœ€ä¸Šé¢çœ‹èµ·

     - ElasticSearchAutoConfigrationï¼š

       <img src="https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526230654.png" alt="image-20200526230654648" style="zoom: 67%;" />

       ä»…æœ‰ä¸€ä¸ªTransportClientçš„Beanï¼Œè¿™ä¸ªç±»ç›¸å¯¹ä¸æˆ‘ä»¬ä½¿ç”¨çš„RestClientï¼Œå…¶ä½¿ç”¨çš„apiæ›´åŠ æ¥è¿‘ä¸åŸç”Ÿæ“ä½œã€‚

     - å¯¹åº”çš„ElasticSearchProperties

       å…¶ä¸­çš„å†…å®¹ä¹Ÿæ¯”è¾ƒå°‘ï¼Œå¤§å¤šæ˜¯å…³äºé›†ç¾¤çš„é…ç½®ï¼š

       <img src="https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526231116.png" alt="image-20200526231116024" style="zoom: 67%;" />

       <img src="https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526231200.png" alt="image-20200526231200416" style="zoom: 80%;" />

     - ElasticsearchDataAutoConfigurationä¸­ä¸»è¦æ˜¯å¯¼å…¥äº†ElasticsearchDataConfigurationä¸­çš„ä¸œè¥¿

       ![image-20200526231656037](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526231723.png)

       æˆ‘ä»¬ç›´æ¥çœ‹åè€…ï¼š

       ä¸€çœ‹æ‰å‘ç°å¯¼å…¥çš„éƒ½æ˜¯é™æ€å†…éƒ¨ç±»ï¼š

       ![image-20200526231857330](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526231857.png)

       å…¶ä¸­çš„`RestClientConfiguration`ç±»å…³æ³¨ä¸€ä¸‹ï¼Œä½¿ç”¨RestHighLevelClientåˆ›å»ºäº†ä¸€ä¸ªElasticsearchRestTemplate(è§åˆ°Templateç¬é—´ä¸¥è‚ƒï¼Œè¿™ä¸ªå¯èƒ½å°±æ˜¯æˆ‘ä»¬è°ƒç”¨apiéœ€è¦çš„ç±»äº†)

       ![image-20200526232142309](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526232142.png)

       æœä¸å…¶ç„¶ï¼Œè¿™ä¸ªç±»ä¸­çš„æ–¹æ³•å¯ä»¥å¤Ÿæµ‹äº†ï¼šæˆªå–éƒ¨åˆ†ï¼š

       <img src="https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526234730.png" alt="image-20200526234730230" style="zoom:80%;" />

       

       åé¢å…­ä¸ªå°±ä¸çœ‹äº†ï¼Œç»§ç»­çœ‹elasticsearch.reståŒ…é‡Œé¢çš„ç±»æŠŠã€‚

     - é¦–å…ˆï¼šRestClientAutoConfigurationï¼Œå’Œä¸Šé¢å¦‚å‡ºä¸€è¾™å¯¼å…¥ä¸€å †ç±»ï¼Œæ²¡çŒœé”™åº”è¯¥ä¹Ÿæ˜¯é™æ€å†…éƒ¨ç±»

       ![image-20200526235119539](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526235119.png)

     - çœ‹çœ‹RestClientConfigurationsç±»

       ä¸å‡ºæ‰€æ–™æœç„¶æ˜¯ä¸‰ä¸ªé™æ€å†…éƒ¨ç±»ï¼š

       ![image-20200526235308792](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200526235308.png)

       ä¸­é—´çš„RestHighLevelClientConfigurationå¼•èµ·æ³¨æ„ï¼ï¼

       <img src="https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200527000929.png" alt="image-20200527000929035" style="zoom:67%;" />

       é»˜è®¤æƒ…å†µä¸‹è¿™ä¸ªç±»æä¾›äº†ä¸¤ä¸ªBeanï¼šRestHighLevelClientå’ŒRestClientï¼Œä½†æ˜¯æˆ‘ä»¬é…ç½®äº†æˆ‘ä»¬è‡ªå·±çš„RestHighLevelClientï¼Œæ‰€ä»¥è¿™ä¸ªBeanä¹Ÿå°±å¤±æ•ˆäº†ã€‚

     - ç„¶åå°±æ˜¯RestClientPropertiesï¼Œé‡Œé¢æ˜¯ä¸€äº›å…³äºå®¢æˆ·ç«¯è¿æ¥çš„é…ç½®ï¼Œ

       é»˜è®¤è¿æ¥uriæ˜¯ï¼šhttp://localhost:9200

       è¿æ¥è¶…æ—¶æ˜¯1sï¼Œè¯»å–è¶…æ—¶æ˜¯30sã€‚

       ![image-20200527001412356](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200527001412.png)

     - æœ€åæœ€åæ˜¯ä¸€ä¸ªæ¥å£RestClientBuilderCustomizerï¼Œç”¨äºå®šåˆ¶åŒ–RestClientï¼Œå’±ä¼°è®¡ä¹Ÿç”¨ä¸åˆ°ï¼Œç›´æ¥ç•¥è¿‡äº†ã€‚

   - OKï¼Œä»¥ä¸Šå°±æ˜¯ä¸€æ¬¡ç®€å•çš„æºç æµè§ˆï¼Œ(ä¸æ•¢ç»†è¯»ğŸ˜„)



### åŸºæœ¬APIä½¿ç”¨

åœ¨APIè°ƒç”¨éƒ¨åˆ†å­¦ä¹ ä¹‹å‰ï¼Œè¦ç†æ¸…ä¸€ä¸ªæ¦‚å¿µï¼šæˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„å‘½ä»¤è¡Œæ“ä½œï¼Œå…¶å®éƒ½æ˜¯ä¸€ä¸ªä¸ªå¸¦è¯·æ±‚çš„è¯·æ±‚ï¼Œå¯¹åº”çš„ç»“æœï¼Œåˆ™æ˜¯ElasticSearchå¯¹äºè¯·æ±‚åé¦ˆçš„å“åº”ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨Javaè¿›è¡Œè°ƒç”¨æ—¶å€™ï¼Œæ˜ç¡®æˆ‘ä»¬==å‘å‡ºçš„æ˜¯è¯·æ±‚==ï¼æ‰€ä»¥==ä¸€åˆ‡æ“ä½œéƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªè¯·æ±‚ç„¶åç»™å®¢æˆ·ç«¯å»å¤„ç†å’Œå“åº”ã€‚==

#### ç´¢å¼•æ“ä½œï¼š

- åˆ›å»ºç´¢å¼•

  ```java
  @Autowired
  @Qualifier("restHighLevelClient")
  private RestHighLevelClient client;
  
  @Test
  void testCreateIndex() throws IOException {
     // newä¸€ä¸ªåˆ›å»ºç´¢å¼•çš„è¯·æ±‚,ç´¢å¼•åä¸ºtest_index01
     CreateIndexRequest request = new CreateIndexRequest("test_index01");
     // å®¢æˆ·ç«¯å‘é€è¯·æ±‚
     CreateIndexResponse response = client.indices().create(request, RequestOptions.DEFAULT);
  }
  ```

  ![image-20200527142805858](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200527142806.png)

  ç›®å‰è¿™ä¸ªç´¢å¼•ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œç¨ååœ¨æ–‡æ¡£çš„APIæ“ä½œä¸­ä½¿ç”¨

- æŸ¥è¯¢ç´¢å¼•æ˜¯å¦å­˜åœ¨

  ```java
  @Test
  void testQueryIndex() throws IOException {
     // new ä¸€ä¸ªåˆ¤æ–­ç´¢å¼•æ˜¯å¦å­˜åœ¨çš„è¯·æ±‚
     GetIndexRequest request = new GetIndexRequest("test_index01");
     // å®¢æˆ·ç«¯å‘é€è¯·æ±‚
     boolean isExists = client.indices().exists(request, RequestOptions.DEFAULT);
  
     System.out.println(isExists);
  }
  ```

  åŸºæœ¬ä¸ŠGetIndexRequestå¯ä»¥ç”¨äºè¯·æ±‚å…³äºç´¢å¼•çš„ä¿¡æ¯ã€‚

- åˆ é™¤ç´¢å¼•

  ```java
  @Test
  void testDeleteIndex() throws IOException {
     // new ä¸€ä¸ªåˆ é™¤ç´¢å¼•çš„è¯·æ±‚
     DeleteIndexRequest request = new DeleteIndexRequest("test_index01");
     // å®¢æˆ·ç«¯å‘é€è¯·æ±‚
     AcknowledgedResponse response = client.indices().delete(request, RequestOptions.DEFAULT);
  }
  ```



#### æ–‡æ¡£æ“ä½œ

- åˆ›å»ºæ–‡æ¡£

  ```java
  @Test
  void testAddDocument() throws IOException {
     User user = new User("sakura", 19);
     // åˆ›å»ºä¸€ä¸ªè¯·æ±‚
     IndexRequest request = new IndexRequest("test_index01");
     // put /test_index/_doc/1 {...}
     request.id("1");
     // è®¾ç½®è¶…æ—¶æ—¶é—´
     request.timeout(TimeValue.timeValueSeconds(1));
     // æ”¾å…¥è¯·æ±‚ä½“
     request.source(JSON.toJSONString(user), XContentType.JSON);
  
     IndexResponse response = client.index(request, RequestOptions.DEFAULT);
     System.out.println(response.status());
     System.out.println(response.toString());
  }
  ```
  
  åœ¨å‘½ä»¤è¡Œæ“ä½œä¸­æˆ‘ä»¬åˆ›å»ºæ–‡æ¡£çš„éƒ½éœ€è¦ä¸€ä¸ªè¯·æ±‚ä½“ï¼Œå­˜æ”¾æˆ‘ä»¬è¦æ’å…¥çš„æ•°æ®ã€‚
  åœ¨è°ƒç”¨APIæ—¶å€™ï¼Œå°†å®ä½“ç±»è½¬åŒ–ä¸ºjsonå­—ç¬¦ä¸²ç„¶åé™„åŠ ç»™è¯·æ±‚å°±å¯ä»¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœã€‚
  
  è¿™æ˜¯å“åº”ä¿¡æ¯ï¼š
  
  ```txt
  CREATED
  IndexResponse[
      index=test_index01,
      type=_doc,
      id=1,
      version=1,
      result=created,
      seqNo=0,
      primaryTerm=1,
      shards=
      {
       "total":2,
       "successful":1,
       "failed":0
      }
  ]
  ```
  
- æŸ¥è¯¢æ–‡æ¡£æ˜¯å¦å­˜åœ¨

  ```java
  @Test
  void testDocumentExist() throws IOException {
     GetRequest request = new GetRequest("test_index01", "2");
     boolean exists = client.exists(request, RequestOptions.DEFAULT);
     System.out.println(exists);
  }
  ```

  æ˜¾ç„¶ç»“æœæ˜¯Falseã€‚

- æŸ¥çœ‹æ–‡æ¡£

  ```java
  @Test
  void testGetDocument() throws IOException {
     // æ–¹å¼ä¸€
     GetSourceRequest request = new GetSourceRequest("test_index01", "1");
     GetSourceResponse response = client.getSource(request, RequestOptions.DEFAULT);
     System.out.println(response.getSource().toString());
  
     // æ–¹å¼äºŒ
     GetRequest request1 = new GetRequest("test_index01", "1");
     GetResponse response1 = client.get(request1, RequestOptions.DEFAULT);
     System.out.println(response1.getSourceAsString());
  }
  ```

  ä¸¤ç§æ–¹æ³•éƒ½èƒ½å¤Ÿè·å–æ–‡æ¡£çš„source(å­—æ®µä¿¡æ¯)ï¼Œå‰è€…åªèƒ½ä»¥Mapå½¢å¼å±•ç¤ºï¼Œåè€…åŠŸèƒ½æ›´å¼ºå¤§å¯ä»¥ä»¥jsonå­—ç¬¦ä¸²å½¢å¼å±•ç¤ºï¼›

  ![image-20200527164446213](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200527164446.png)

  ä¸”ç¬¬äºŒç§æ–¹å¼çš„å“åº”è¿˜å¯ä»¥æŸ¥çœ‹å…¶ä»–ä¿¡æ¯,ç¬¬ä¸€ç§æ–¹å¼ä»…ä»…æŸ¥çœ‹å­—æ®µä¿¡æ¯ã€‚

  ![image-20200527164541625](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200527164541.png)

- æ›´æ–°æ–‡æ¡£

  ```java
  @Test
  void testUpdateDocument() throws IOException {
     UpdateRequest request = new UpdateRequest("test_index01", "1");
     HashMap<String, Object> map = new HashMap<>();
     map.put("name", "å®˜å®‡è¾°");
     map.put("age", 19);
     request.doc(map, XContentType.JSON);
     UpdateResponse response = client.update(request, RequestOptions.DEFAULT);
     System.out.println(response.status());
  }
  
  @Test
  void testUpdateDocument2() throws IOException {
     UpdateRequest request = new UpdateRequest("test_index01", "1");
     User user = new User("å®˜å®‡è¾°", 20);
     request.doc(JSON.toJSONString(user), XContentType.JSON);
     UpdateResponse response = client.update(request, RequestOptions.DEFAULT);
     System.out.println(response.status());
  }
  ```

  ä¹Ÿæ˜¯ä¸¤ç§æ–¹å¼ï¼šä¸€ç§æ˜¯mapå°è£…ä¼ å‚ï¼Œä¸€ç§çš„å¯¹è±¡è½¬jsonå­—ç¬¦åºŠä¼ å‚ã€‚
  åœ¨ä½¿ç”¨å‘½ä»¤è¡Œçš„æ—¶å€™ï¼Œå°±è¯´æ˜è¿‡updateè¯·æ±‚ä¸­æœ‰ä¸€ä¸ªdocå¯¹è±¡ï¼Œé‡Œé¢æ”¾ç€è¦ä¿®æ”¹çš„å­—æ®µå’Œå€¼ã€‚

  ==ä½¿ç”¨mapå°è£…å‚æ•°çš„çš„è¯å¯ä»¥å®Œæˆéƒ¨åˆ†å­—æ®µçš„ä¿®æ”¹==ï¼Œä½†æ˜¯åè€…åˆ™æ˜¯å°†ä¸€ä¸ªæ–°å¯¹è±¡è¦†ç›–åˆ°æ—§è®°å½•ä¸Šï¼Œæœ‰æ—¶å€™å³ä½¿å­—æ®µæ²¡æœ‰è®¾ç½®å€¼ä¹Ÿä¼šä½¿ç”¨é»˜è®¤å€¼è¿›è¡Œæ›¿æ¢ï¼Œæ¯”å¦‚intç±»å‹çš„å­—æ®µé»˜è®¤å°±æ˜¯0ã€‚

- åˆ é™¤æ–‡æ¡£

  ```java
  @Test
  void testDeleteDocument() throws IOException {
     DeleteRequest request = new DeleteRequest("test_index01", "1");
     DeleteResponse response = client.delete(request, RequestOptions.DEFAULT);
     System.out.println(response.status());
  }
  ```

- æ‰¹é‡å¤„ç†(bulk)

  ```java
  @Test
  void testBulkRequest() throws IOException {
     BulkRequest request = new BulkRequest("test_index01");
  
     List<User> users = new ArrayList<>();
     users.add(new User("AAAA", 19));
     users.add(new User("BBBB", 21));
     users.add(new User("CCCC", 18));
     users.add(new User("DDDD", 23));
     users.add(new User("EEEE", 16));
     users.add(new User("FFFF", 25));
     users.add(new User("GGGG", 22));
  
     for (int i = 0; i < users.size(); i++) {
        IndexRequest indexRequest = new IndexRequest("test_index01");
        indexRequest.id(String.valueOf(i));
        indexRequest.source(JSON.toJSONString(users.get(i)), XContentType.JSON);
        request.add(indexRequest);
     }
  
     BulkResponse response = client.bulk(request, RequestOptions.DEFAULT);
     // æ˜¯å¦æœ‰å¤±è´¥çš„è¯·æ±‚
     System.out.println(response.hasFailures());
     System.out.println(response.status());
  
  }
  ```

  æ‰¹å¤„ç†æ˜¯å¯¹å¤šä¸ªè¯·æ±‚è¿›è¡Œé›†ä¸­å¤„ç†ã€‚

  

- æœç´¢æ–‡æ¡£(åŸºæœ¬æ“ä½œ)

  é¦–å…ˆè¦ç¡®å®šè¯·æ±‚çš„ç±»å‹æ˜¯`SearchRequest`

  éœ€è¦ä½¿ç”¨`QueryBuilder`ç±»åŠå…¶å·¥å…·ç±»`QueryBuilders`ï¼Œä»¥åŠä¸€ä¸ª`SearchSourceBuilder`

  æ¨èé˜…è¯»ï¼š<https://www.cnblogs.com/wenbronk/p/6432990.html>

  > **å…¨æŸ¥è¯¢match_all**

  ```java
  @Test
  void testSearch() throws IOException {
     SearchRequest request = new SearchRequest("test_index01");
  
     // åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢
     QueryBuilder queryBuilder = QueryBuilders.matchAllQuery();
     // åˆ›å»ºä¸€ä¸ªæœç´¢
     SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();
  
     sourceBuilder.query(queryBuilder);
     request.source(sourceBuilder);
     SearchResponse response = client.search(request, RequestOptions.DEFAULT);
     SearchHits hits = response.getHits();
     Iterator<SearchHit> iterator = hits.iterator();
     while (iterator.hasNext()) {
        System.out.println(iterator.next());
     }
  }
  ```

  é¦–å…ˆè¦ç¡®å®šæŸ¥è¯¢æ¡ä»¶ï¼šQueryBuilderï¼Œåˆ©ç”¨QueryBuilderså·¥å…·ç±»åŸºæœ¬ä¸Šå¯ä»¥æå®šã€‚

  ç„¶åæŠŠQueryBuilderç»™SearchSourceBuilder.source()ï¼Œåˆ›å»ºä¸€ä¸ªæŒ‰æŸ¥è¯¢æ¡ä»¶æœç´¢sourceçš„æœç´¢

  ç„¶åå†æŠŠè¿™ä¸ªSearchSourceBuilderè®¾ç½®åˆ°è¯·æ±‚ä¸­ï¼Œç„¶åç”±å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ã€‚

  > ç»“æœçš„è·å–å’Œè¾“å‡ºï¼š
  >
  > æˆ‘ä»¬åœ¨ä½¿ç”¨å‘½ä»¤è¡Œå°±è¯´è¿‡æ¯ä¸€æ¡è®°å½•éƒ½æ˜¯ç”¨ä¸€ä¸ªhitå¯¹è±¡åŒ…è£¹èµ·æ¥çš„ï¼Œåœ¨Javaä¸­è¿™ä¸ªå¯¹è±¡æ˜¯`SearchHit`
  >
  > ä»å“åº”ä¸­è·å–hitsæ•°ç»„(`SearchHits`)ï¼Œç„¶åç”¨è¿­ä»£å™¨è¾“å‡ºæˆ–è€…éå†è¾“å‡ºã€‚

  ç»“æœ(éƒ¨åˆ†)ä¸€ç›®äº†ç„¶ï¼š

  ```json
  {
    "_index" : "test_index01",
    "_type" : "_doc",
    "_id" : "0",
    "_score" : 1.0,
    "_source" : {
      "age" : 19,
      "name" : "AAAA"
    }
  }
  {
    "_index" : "test_index01",
    "_type" : "_doc",
    "_id" : "1",
    "_score" : 1.0,
    "_source" : {
      "age" : 21,
      "name" : "BBBB"
    }
  }
  
  ...
  ```

   

  > matchæ¡ä»¶æŸ¥è¯¢

  ```java
  @Test
  void testMatch() throws IOException {
     SearchRequest request = new SearchRequest("test_index01");
     SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();
     QueryBuilder queryBuilder = QueryBuilders.matchQuery("name", "BBBB");
     sourceBuilder.query(queryBuilder);
     sourceBuilder.fetchSource("name", null);
  
     request.source(sourceBuilder);
     SearchResponse response = client.search(request, RequestOptions.DEFAULT);
     SearchHits hits = response.getHits();
     for (SearchHit hit : hits) {
        System.out.println(hit);
     }
  }
  ```

  ä¸­é—´ç”¨åˆ°äº†SearchSourceBuilderçš„`fetchSource`çš„æ–¹æ³•,ç›¸å½“äºæˆ‘ä»¬è¯·æ±‚ä½“ä¸­`_source`çš„ä½œç”¨ï¼Œå³æ˜¾ç¤º/æ’é™¤å“ªäº›å­—æ®µã€‚
  ç»“æœï¼š(æœç„¶åªæ˜¾ç¤ºäº†name)

  ```json
  {
    "_index" : "test_index01",
    "_type" : "_doc",
    "_id" : "1",
    "_score" : 1.6739764,
    "_source" : {
      "name" : "BBBB"
    }
  }
  
  ```

  

   

  > æŸ¥è¯¢ç»“æœåˆ†é¡µã€æ’åº

  ```java
  @Test
  void testSortAndPages() throws IOException {
     SearchRequest request = new SearchRequest("test_index01");
  
     // åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢
     QueryBuilder queryBuilder = QueryBuilders.matchAllQuery();
     // åˆ›å»ºä¸€ä¸ªæœç´¢
     SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();
  
     sourceBuilder.query(queryBuilder);
     sourceBuilder.sort("age");
     // sourceBuilder.sort("age", SortOrder.ASC); (é»˜è®¤ï¼)
     // sourceBuilder.sort("age", SortOrder.DESC);
     sourceBuilder.from(0);
     sourceBuilder.size(3);
  
     request.source(sourceBuilder);
     SearchResponse response = client.search(request, RequestOptions.DEFAULT);
     SearchHits hits = response.getHits();
     
     for (SearchHit hit : hits) {
        System.out.println(hit);
     }
  }
  ```

  è¿˜æ˜¯å’Œè¯·æ±‚ä½“ä¸€è‡´ï¼šä½¿ç”¨SearchSourceBuilderçš„æ–¹æ³•ï¼š

  `sort()`:é€‰æ‹©å­—æ®µæ’åºï¼Œé»˜è®¤æ˜¯å‡åºæ’åˆ—

  `from()`ã€`size()`:åˆ†é¡µçš„ç›¸å…³è®¾ç½®ï¼Œèµ·å§‹ä½ç½®å’Œé¡µé¢å¤§å°
  ç»“æœï¼š

  ```json
  {
    "_index" : "test_index01",
    "_type" : "_doc",
    "_id" : "4",
    "_score" : null,
    "_source" : {
      "age" : 16,
      "name" : "EEEE"
    },
    "sort" : [
      16
    ]
  }
  {
    "_index" : "test_index01",
    "_type" : "_doc",
    "_id" : "2",
    "_score" : null,
    "_source" : {
      "age" : 18,
      "name" : "CCCC"
    },
    "sort" : [
      18
    ]
  }
  {
    "_index" : "test_index01",
    "_type" : "_doc",
    "_id" : "0",
    "_score" : null,
    "_source" : {
      "age" : 19,
      "name" : "AAAA"
    },
    "sort" : [
      19
    ]
  }
  ```

   

  > ç²¾å‡†æŸ¥è¯¢term

  ```java
  @Test
  void testTerm() throws IOException {
     SearchRequest request = new SearchRequest("test_index01");
     SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();
     QueryBuilder queryBuilder = QueryBuilders.termQuery("name", "aaaa");
     //QueryBuilder queryBuilder = QueryBuilders
     //                             .termsQuery("name", "bbbb", "cccc", "dddd");
     sourceBuilder.query(queryBuilder);
     request.source(sourceBuilder);
     SearchResponse response = client.search(request, RequestOptions.DEFAULT);
     SearchHits hits = response.getHits();
     for (SearchHit hit : hits) {
        System.out.println(hit);
     }
  }
  ```

  ==æ³¨æ„ï¼ï¼==ï¼šä¸çŸ¥æ˜¯Bugè¿˜æ˜¯é»˜è®¤çš„è§„åˆ™,å½“æˆ‘ä»¬çš„==å­—æ®µå€¼åŒ…å«äº†å¤§å†™è‹±æ–‡å­—æ¯ï¼Œåœ¨ç»è¿‡åˆ†è¯è§£æçš„æ—¶å€™ä¼šå˜ä¸ºå°å†™ï¼(é™¤äº†keywordå¤–)==ä½†æ˜¯æ˜¾ç¤ºçš„æ•°æ®ä»ç„¶æ˜¯å¤§å†™ã€‚

  ä¸Šé¢çš„å®ä¾‹ä¸­å¦‚æœæ˜¯term(â€œnameâ€,â€AAAAâ€)æ˜¯åŒ¹é…ä¸åˆ°{â€œnameâ€:â€AAAAâ€,â€ageâ€:19}è¿™æ¡è®°å½•çš„ã€‚å› ä¸ºåœ¨åˆ†è¯è§£æè¿‡ç¨‹ä¸­å˜ä¸ºäº†å°å†™ï¼š

  ![image-20200527223117837](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200527223117.png)

   è¿™ä¸€ç‚¹åœ¨matchä¸­ä¸å¿…å¤šè™‘ï¼Œå› ä¸ºæœç´¢è¯ä¹Ÿä¼šè¢«åŒæ ·å¤„ç†ğŸ˜„ã€‚

  

  > å¤šæ¡ä»¶åŒ¹é…(bool-queryä¹‹mustã€notmustã€shouldã€filter)

  ```java
  @Test
  	void testBoolQuery() throws IOException {
  		SearchRequest request = new SearchRequest("test_index01");
  		SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();
  		BoolQueryBuilder queryBuilder = QueryBuilders.boolQuery()
  				.must(QueryBuilders.matchQuery("name", "EEEE"))
  				.filter(QueryBuilders.rangeQuery("age").gte(15).lte(24))
                 .mustNot(QueryBuilders.rangeQuery("id").gte(5));
  		sourceBuilder.query(queryBuilder);
  		request.source(sourceBuilder);
  		SearchResponse response = client.search(request, RequestOptions.DEFAULT);
  		SearchHits hits = response.getHits();
  		hits.forEach(System.out::println);
  	}
  ```

  é€‰æ‹©äº†ä»£è¡¨æ€§è¾ƒé«˜çš„mustã€mustNotå’ŒrangeQuery

   

  > å¤šå€¼æŸ¥è¯¢

  - ä½¿ç”¨termsï¼Œåœ¨termä¸­æœ‰æ¼”ç¤º
  - matchä¸­åŒ¹é…å€¼ä»¥ç©ºæ ¼éš”å¼€

  ```java
  @Test
  void testMatch() throws IOException {
     SearchRequest request = new SearchRequest("test_index01");
     SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();
     QueryBuilder queryBuilder = QueryBuilders.matchQuery("name", "BBBB CCCC EEEE");
     sourceBuilder.query(queryBuilder);
     sourceBuilder.fetchSource("name", null);
  
     request.source(sourceBuilder);
     SearchResponse response = client.search(request, RequestOptions.DEFAULT);
     SearchHits hits = response.getHits();
     for (SearchHit hit : hits) {
        System.out.println(hit);
     }
  }
  ```

  åŒ¹é…å€¼æ˜¯â€œBBBB CCCC EEEEâ€ï¼Œå¯ä»¥æ‹†åˆ†ä¸ºâ€œbbbbâ€ã€â€œccccâ€ã€â€œeeeeâ€

  ![image-20200527225126755](https://picbed-sakura.oss-cn-shanghai.aliyuncs.com/notePic/20200527225126.png)

   

  > é«˜äº®æŸ¥è¯¢ï¼

  ```java
  @Test
  void testHighlight() throws IOException {
     SearchRequest request = new SearchRequest("test_index01");
     SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();
     QueryBuilder queryBuilder = QueryBuilders.matchQuery("name", "CCCC");
     HighlightBuilder highlightBuilder = new HighlightBuilder();
     highlightBuilder.field("name");
     highlightBuilder.preTags("<span class='key' style='color:red'>");
     highlightBuilder.postTags("</span>");
  
     sourceBuilder.highlighter(highlightBuilder);
     sourceBuilder.query(queryBuilder);
     request.source(sourceBuilder);
     SearchResponse response = client.search(request, RequestOptions.DEFAULT);
     SearchHits hits = response.getHits();
     hits.forEach(System.out::println);
  }
  ```

  å‡ºç°äº†ä¸€ä¸ªæ–°çš„ç±»ï¼š`HighlightBuilder`ï¼Œå…¶ä»–ä½¿ç”¨å’Œå‘½ä»¤è¡Œçš„æ“ä½œå·®ä¸å¤šã€‚ä¸€æ ·è®¾ç½®pre_tagså’Œpost_tags
  ç»“æœï¼š

  ```json
  {
    "_index" : "test_index01",
    "_type" : "_doc",
    "_id" : "2",
    "_score" : 1.6739764,
    "_source" : {
      "age" : 18,
      "name" : "CCCC"
    },
    "highlight" : {
      "name" : [
        "<span class='key' style='color:red'>CCCC</span>"
      ]
    }
  }
  ```





## äº”ã€å®æˆ˜

### Javaçˆ¬è™«åŸºç¡€

`jsoup`(æœ¬æ¬¡ä½¿ç”¨)ã€`tika`

```xml
<dependency>
    <groupId>org.jsoup</groupId>
    <artifactId>jsoup</artifactId>
    <version>1.10.2</version>
</dependency>
```